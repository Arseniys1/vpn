import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import SectionHeader from '../components/SectionHeader';
import { ServerLocation, UserSubscription, ServerStatus } from '../types';
import * as api from '../services/api';

interface TunnelsProps {
  subscription: UserSubscription;
  onReport: (server: ServerLocation) => void;
}

const Tunnels: React.FC<TunnelsProps> = ({ subscription, onReport }) => {
  const navigate = useNavigate();
  const [activeServerId, setActiveServerId] = useState<string | null>(null);
  const [servers, setServers] = useState<ServerLocation[]>([]);
  const [connections, setConnections] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      setLoading(true);
      
      // Fetch servers
      const serversData = await api.getServers();
      const serversList = (serversData.servers || []).map((s: any) => ({
        id: s.id,
        country: s.country,
        flag: s.flag,
        ping: s.ping || 50,
        status: s.status as ServerStatus,
        protocol: s.protocol,
        adminMessage: s.admin_message
      }));
      setServers(serversList);
      
      // Fetch user connections if subscribed
      if (subscription.active) {
        const connectionsData = await api.getMyConnections();
        setConnections(connectionsData.connections || []);
      }
    } catch (error) {
      console.error('Failed to load servers:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleCreateConnection = async (server: ServerLocation) => {
    if (!subscription.active) {
      navigate('/shop');
      if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
      }
      return;
    }
    
    // Toggle connection
    if (activeServerId === server.id) {
      setActiveServerId(null);
    } else {
      try {
        // Create connection on backend
        const result = await api.createConnection(server.id);
        setActiveServerId(server.id);
        
        // Reload connections
        const connectionsData = await api.getMyConnections();
        setConnections(connectionsData.connections || []);
        
        if (window.Telegram?.WebApp?.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.selectionChanged();
        }
      } catch (error: any) {
        console.error('Failed to create connection:', error);
        if (window.Telegram?.WebApp?.showAlert) {
          window.Telegram.WebApp.showAlert(error.message || 'Ошибка создания подключения');
        }
      }
    }
  };

  const copyToClipboard = (text: string) => {
     navigator.clipboard.writeText(text);
     if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
     }
  };

  const getKey = (server: ServerLocation) => {
    // Find connection for this server
    const connection = connections.find(c => c.server_id === server.id);
    if (connection && connection.config_url) {
      return connection.config_url;
    }
    return `${server.protocol}://${Math.random().toString(36).substr(2)}@${server.country.toLowerCase()}.vpn.com:443?security=reality&type=tcp&headerType=none#${server.country}-User1`;
  };
  
  const getSubLink = (server: ServerLocation) => {
    const connection = connections.find(c => c.server_id === server.id);
    if (connection && connection.subscription_url) {
      return connection.subscription_url;
    }
    return "";
  };

  if (loading) {
    return (
      <div className="pt-2 w-full">
        <SectionHeader title="Доступные серверы" />
        <div className="flex items-center justify-center p-8">
          <div className="w-8 h-8 border-4 border-tg-blue border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="pt-2 w-full">
      <SectionHeader title="Доступные серверы" />
      <div className="flex flex-col gap-3 px-4">
        {servers.map((server) => {
           const isActive = activeServerId === server.id;
           return (
             <div key={server.id} className={`bg-tg-secondary rounded-xl overflow-hidden shadow-sm transition-all duration-300 border border-transparent hover:border-tg-separator ${isActive ? 'ring-1 ring-tg-blue' : ''}`}>
                <div 
                   onClick={() => handleCreateConnection(server)}
                   className="flex items-center p-4 cursor-pointer active:bg-tg-hover transition-colors"
                >
                   <div className="text-4xl mr-3 min-w-[48px] flex items-center justify-center" style={{fontFamily: 'Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, sans-serif'}}>{server.flag}</div>
                   <div className="flex-1">
                      <div className="flex justify-between items-center mb-1">
                         <span className="font-semibold text-[15px] text-tg-text">{server.country}</span>
                         {subscription.active ? (
                            <span className={`text-[11px] px-2 py-0.5 rounded font-bold ${
                                server.status === ServerStatus.ONLINE ? 'bg-tg-green/10 text-tg-green' : 
                                server.status === ServerStatus.MAINTENANCE ? 'bg-tg-red/10 text-tg-red' : 'bg-orange-400/10 text-orange-400'
                            }`}>
                                {server.ping} ms
                            </span>
                         ) : (
                             <i className="fas fa-lock text-tg-hint text-xs"></i>
                         )}
                      </div>
                      <div className="text-xs text-tg-hint flex items-center">
                         <span className={`w-1.5 h-1.5 rounded-full mr-2 ${
                            server.status === ServerStatus.ONLINE ? 'bg-tg-green' : 
                            server.status === ServerStatus.MAINTENANCE ? 'bg-tg-red' : 'bg-orange-400'
                         }`}></span>
                         {server.status} • {server.protocol.toUpperCase()}
                      </div>
                      {server.adminMessage && (
                         <div className="mt-2 text-xs text-tg-blue bg-tg-blue/10 rounded-lg px-2 py-1.5 flex items-start">
                            <i className="fas fa-info-circle mr-1.5 mt-0.5 flex-shrink-0"></i>
                            <span>{server.adminMessage}</span>
                         </div>
                      )}
                   </div>
                   <div className="ml-3 text-tg-hint">
                      <i className={`fas fa-chevron-down transition-transform duration-300 ${isActive ? 'rotate-180' : ''}`}></i>
                   </div>
                </div>

                {isActive && subscription.active && (
                   <div className="px-4 pb-4 pt-0 bg-tg-hover/30 border-t border-tg-separator animate-fade-in">
                      <div className="mt-4">
                         <label className="text-[11px] text-tg-hint uppercase font-semibold mb-1 block">Ссылка для подключения</label>
                         {getKey(server) ? (
                         <div className="flex items-center bg-tg-bg rounded-lg p-2 border border-tg-separator mb-3">
                            <div className="flex-1 truncate text-xs font-mono text-tg-blue opacity-80 mr-2">
                               {getKey(server)}
                            </div>
                            <button onClick={() => copyToClipboard(getKey(server))} className="w-8 h-8 rounded bg-tg-secondary flex items-center justify-center text-tg-text hover:text-tg-blue transition-colors">
                               <i className="fas fa-copy"></i>
                            </button>
                         </div>
                         ) : (
                         <div className="bg-tg-bg rounded-lg p-3 border border-tg-separator mb-3 text-center">
                           <div className="text-tg-hint text-sm">Создание конфигурации...</div>
                           <div className="text-xs text-tg-hint mt-1">Это может занять несколько секунд</div>
                         </div>
                         )}

                         <label className="text-[11px] text-tg-hint uppercase font-semibold mb-1 block">Ссылка на подписку</label>
                         {getSubLink(server) ? (
                         <div className="flex items-center bg-tg-bg rounded-lg p-2 border border-tg-separator mb-4">
                            <div className="flex-1 truncate text-xs font-mono text-tg-blue opacity-80 mr-2">
                               {getSubLink(server)}
                            </div>
                            <button onClick={() => copyToClipboard(getSubLink(server))} className="w-8 h-8 rounded bg-tg-secondary flex items-center justify-center text-tg-text hover:text-tg-blue transition-colors">
                               <i className="fas fa-copy"></i>
                            </button>
                         </div>
                         ) : (
                         <div className="bg-tg-bg rounded-lg p-3 border border-tg-separator mb-4 text-center">
                           <div className="text-tg-hint text-sm">Создание подписки...</div>
                           <div className="text-xs text-tg-hint mt-1">Это может занять несколько секунд</div>
                         </div>
                         )}

                         <button 
                            onClick={(e) => { e.stopPropagation(); onReport(server); }} 
                            className="w-full py-2 rounded-lg border border-tg-red/30 text-tg-red text-sm font-medium hover:bg-tg-red/10 transition-colors flex items-center justify-center"
                         >
                            <i className="fas fa-triangle-exclamation mr-2"></i>
                            Сообщить о проблеме
                         </button>
                      </div>
                   </div>
                )}
             </div>
           );
        })}
      </div>
    </div>
  );
};

export default Tunnels;

